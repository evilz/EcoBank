<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:EcoBank.App.ViewModels.Auth"
             xmlns:auth="using:EcoBank.App.Views.Auth"
             xmlns:shad="clr-namespace:ShadUI;assembly=ShadUI"
             x:Class="EcoBank.App.Views.Auth.LoginView"
             x:DataType="vm:LoginViewModel"
             Background="White">

  <UserControl.Styles>
    <Style Selector="Button.Ghost">
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderThickness" Value="1.5" />
      <Setter Property="BorderBrush" Value="#0F523A" />
      <Setter Property="Foreground" Value="#0F523A" />
      <Setter Property="CornerRadius" Value="24" />
      <Setter Property="Padding" Value="24,14" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="FontSize" Value="16" />
    </Style>
    <Style Selector="Button.Ghost:pointerover">
      <Setter Property="Background" Value="#F0F8F5" />
    </Style>
    <Style Selector="Button.PrimaryAction">
      <Setter Property="Background" Value="#102636" />
      <Setter Property="Foreground" Value="White" />
      <Setter Property="CornerRadius" Value="8" />
      <Setter Property="Padding" Value="0,16" />
      <Setter Property="FontWeight" Value="Bold" />
      <Setter Property="FontSize" Value="16" />
      <Setter Property="HorizontalContentAlignment" Value="Center" />
    </Style>
    <Style Selector="Button.PrimaryAction:pointerover">
      <Setter Property="Background" Value="#0F523A" />
    </Style>
  </UserControl.Styles>

  <ScrollViewer>
    <Panel Margin="0">
      
      <!-- ============================================== -->
      <!-- STATE: PROFILE SELECTION                       -->
      <!-- ============================================== -->
      <StackPanel IsVisible="{Binding IsProfileSelectionState}" HorizontalAlignment="Center" MaxWidth="500" Margin="24,64,24,24" Spacing="0">
        
        <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,32">
          <TextBlock Grid.Column="0" Text="Bonjour" FontSize="32" FontWeight="Bold" Foreground="#102636" VerticalAlignment="Center" />
          <Button Grid.Column="1" Content="â‹®" Background="Transparent" Foreground="#102636" FontSize="24" FontWeight="Bold" CornerRadius="20" Width="40" Height="40" HorizontalContentAlignment="Center" VerticalContentAlignment="Center" />
        </Grid>
        
        <TextBlock Text="MON PROFIL FAVORI" FontSize="12" FontWeight="Bold" Foreground="#6C7A89" Margin="0,0,0,16" />

        <ItemsControl ItemsSource="{Binding Profiles}">
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <!-- Card mimicking the image -->
              <shad:Card Margin="0,0,0,24" Padding="0" CornerRadius="16">
                <!-- Wrap in a grid for precise layout inside the card -->
                <Grid RowDefinitions="120, Auto">
                  
                  <!-- Cover image area / Bank abstract background -->
                  <Border Grid.Row="0" CornerRadius="16,16,0,0" Background="#A1D0B7" ClipToBounds="True">
                    <Grid>
                       <!-- Layered green hills effect using simple shapes -->
                       <Border Background="#84C69E" CornerRadius="60" Height="80" Width="600" VerticalAlignment="Bottom" Margin="-50,0,-50,-30" />
                       <Border Background="#5EB27E" CornerRadius="50" Height="60" Width="500" VerticalAlignment="Bottom" Margin="-30,0,-30,-20" />
                       <Border Background="#35985A" CornerRadius="40" Height="40" Width="700" VerticalAlignment="Bottom" Margin="-100,0,-100,-10" />
                       
                       <!-- Bank Logo mock -->
                       <Border Width="72" Height="72" CornerRadius="36" Background="White" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="24,0,0,0">
                         <TextBlock Text="ðŸŒ¿" FontSize="36" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#0F523A" />
                       </Border>
                    </Grid>
                  </Border>

                  <!-- Card content area -->
                  <Border Grid.Row="1" Padding="24">
                    <StackPanel>
                      <TextBlock Text="{Binding DisplayName}" FontSize="20" FontWeight="SemiBold" Foreground="#102636" Margin="0,0,0,4" />
                      <TextBlock Text="{Binding MaskedClientId}" FontSize="14" Foreground="#6C7A89" Margin="0,0,0,4" />
                      <TextBlock Text="EcoBank" FontSize="14" Foreground="#A0AAB5" Margin="0,0,0,16" />
                    
                      <Border Height="1" Background="#EAECEF" Margin="-24,0,-24,16" />

                      <Button Content="Me connecter" 
                              Command="{Binding $parent[UserControl].((vm:LoginViewModel)DataContext).SelectProfileCommand}"
                              CommandParameter="{Binding}"
                              Background="Transparent"
                              Foreground="#0F523A"
                              FontWeight="Bold"
                              FontSize="16"
                              Padding="0"
                              HorizontalAlignment="Left" />
                    </StackPanel>
                  </Border>
                </Grid>
              </shad:Card>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <Button Classes="Ghost" 
                Content="Ajouter un profil" 
                Command="{Binding NavigateToAddProfileCommand}" 
                HorizontalAlignment="Center" 
                Margin="0,16"/>
      </StackPanel>


      <!-- ============================================== -->
      <!-- STATE: PIN ENTRY                               -->
      <!-- ============================================== -->
      <StackPanel IsVisible="{Binding IsPinEntryState}" HorizontalAlignment="Center" MaxWidth="500" Margin="24,48,24,24" Spacing="0">
        
        <!-- Profile Pill -->
        <Button Command="{Binding CancelPinEntryCommand}"
                Background="White" 
                BorderThickness="1"
                BorderBrush="#EAECEF"
                Foreground="#0F523A" 
                CornerRadius="24" 
                HorizontalAlignment="Center"
                Margin="0,0,0,48"
                Padding="16,8">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="{Binding SelectedProfile.DisplayName}" FontWeight="SemiBold" VerticalAlignment="Center"/>
            <TextBlock Text="âœ•" FontSize="12" Foreground="#6C7A89" VerticalAlignment="Center"/>
          </StackPanel>
        </Button>

        <TextBlock Text="Mes identifiants" FontSize="32" FontWeight="Bold" Foreground="#102636" Margin="0,0,0,8"/>
        <TextBlock Text="Saisissez votre code PIN" FontSize="16" Foreground="#6C7A89" Margin="0,0,0,48"/>

        <!-- Error message -->
        <Border Background="#FFF1F0" CornerRadius="8" Padding="12,10" IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" BorderBrush="#FF4D4F" BorderThickness="1" Margin="0,0,0,16">
          <TextBlock Text="{Binding ErrorMessage}" Foreground="#FF4D4F" TextWrapping="Wrap" FontSize="13" TextAlignment="Center"/>
        </Border>

        <!-- OTP PIN Input Component -->
        <auth:OtpPinInput x:Name="OtpPinInput" 
                         OtpValue="{Binding Pin, Mode=TwoWay}"
                         Margin="0,0,0,32" />

        <TextBlock Text="Code PIN oubliÃ© ?" 
                   Foreground="#0F523A" 
                   FontWeight="SemiBold"
                   HorizontalAlignment="Center"
                   Margin="0,0,0,64"/>

        <Button Classes="PrimaryAction"
                Content="Continuer"
                Command="{Binding SubmitPinCommand}"
                shad:ButtonAssist.ShowProgress="{Binding IsBusy}"
                HorizontalAlignment="Stretch"
                Height="56"/>
      </StackPanel>


      <!-- ============================================== -->
      <!-- STATE: ADD PROFILE                             -->
      <!-- ============================================== -->
      <StackPanel IsVisible="{Binding IsAddProfileState}" HorizontalAlignment="Center" MaxWidth="500" Margin="24,48,24,24" Spacing="0">
        
        <StackPanel Spacing="8" Margin="0,0,0,32">
          <TextBlock Text="EcoBank" FontSize="40" FontWeight="Bold" Foreground="#0F523A" />
          <TextBlock Text="Ajouter un profil" FontSize="24" FontWeight="SemiBold" Foreground="#102636"/>
          <TextBlock Text="Saisissez vos informations pour associer votre compte." FontSize="15" Foreground="#6C7A89" TextWrapping="Wrap"/>
        </StackPanel>

        <shad:Card Margin="0,0,0,24" CornerRadius="16" Padding="24">
          <StackPanel Spacing="20">
            <TextBox shad:ControlAssist.Label="Client ID" Text="{Binding ClientId}" IsEnabled="{Binding !IsBusy}"/>
            <TextBox shad:ControlAssist.Label="Client Secret" Text="{Binding ClientSecret}" PasswordChar="â€¢" IsEnabled="{Binding !IsBusy}"/>
            <TextBox shad:ControlAssist.Label="App User ID" Text="{Binding AppUserId}" IsEnabled="{Binding !IsBusy}"/>
            
            <Border Height="1" Background="#EAECEF" Margin="0,8"/>
            
            <TextBlock Text="DÃ©finissez un code PIN pour simplifier vos prochaines connexions :" FontSize="14" Foreground="#6C7A89" TextWrapping="Wrap"/>
            
            <TextBox shad:ControlAssist.Label="Code PIN (Nouveau)" Text="{Binding NewPin}" PasswordChar="â€¢" MaxLength="8" IsEnabled="{Binding !IsBusy}"/>
            
            <CheckBox IsChecked="{Binding RememberCredentials}" Content="Enregistrer le profil" IsEnabled="{Binding !IsBusy}"/>

            <!-- Error message -->
            <Border Background="#FFF1F0" CornerRadius="8" Padding="12,10" IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" BorderBrush="#FF4D4F" BorderThickness="1">
              <TextBlock Text="{Binding ErrorMessage}" Foreground="#FF4D4F" TextWrapping="Wrap" FontSize="13"/>
            </Border>

            <Button Classes="PrimaryAction" Content="Enregistrer &amp; Continuer" Command="{Binding LoginCommand}" IsEnabled="{Binding !IsBusy}" shad:ButtonAssist.ShowProgress="{Binding IsBusy}" HorizontalAlignment="Stretch" Height="56" Margin="0,16,0,0"/>
            
            <Button Content="Annuler" 
                    Command="{Binding CancelAddProfileCommand}" 
                    Background="Transparent" 
                    Foreground="#6C7A89"
                    FontWeight="SemiBold"
                    HorizontalAlignment="Stretch"
                    IsVisible="{Binding HasProfiles}"
                    Height="48" />
          </StackPanel>
        </shad:Card>
      </StackPanel>

    </Panel>
  </ScrollViewer>
</UserControl>
